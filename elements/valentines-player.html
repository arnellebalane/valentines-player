<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="playlist-panel.html">


<dom-module id="valentines-player">
    <template>
        <iron-ajax id="playlist-data" url="[[playlistSource]]" handle-as="json" on-response="_fetchPlaylistAudioFiles" auto></iron-ajax>

        <playlist-panel id="playlist" items="[[playlist]]" selected="[[index]]"></playlist-panel>
    </template>

    <script>
        Polymer({
            is: 'valentines-player',

            properties: {
                context: Object,

                analyser: Object,

                playlistSource: String,

                playlist: {
                    type: Array,
                    value: _ => []
                },

                index: {
                    type: Number,
                    value: 0
                }
            },

            ready() {
                this.context = new AudioContext();
                this.analyser = this.context.createAnalyser();
                this.analyser.connect(this.context.destination);

                this.$.playlist.addEventListener('playlist-item-select', e => {
                    this.play(e.detail.selected);
                });
            },

            _fetchPlaylistAudioFiles() {
                const playlist = this.$['playlist-data'].lastResponse;
                Promise.all(playlist.map(item => {
                    return fetch(item.url)
                        .then(response => response.blob())
                        .then(response => {
                            item.audio = new Audio();
                            item.audio.src = URL.createObjectURL(response);
                            return item;
                        });
                }))
                .then(playlist => this.playlist = playlist)
                .then(_ => this._connectPlaylistAudioFiles())
                .then(_ => this.play());
            },

            _connectPlaylistAudioFiles() {
                this.playlist.forEach(item => {
                    const source = this.context.createMediaElementSource(item.audio);
                    source.connect(this.analyser);
                });
            },

            audio() {
                return this.playlist[this.index].audio;
            },

            play(index) {
                if (index === undefined) {
                    this.audio().play();
                } else if (index < this.playlist.length) {
                    this.stop();
                    this.index = index;
                    this.audio().play();
                    this.audio().onended = _ => this.next();
                }
            },

            pause() {
                this.audio().pause();
            },

            toggle() {
                if (this.audio().paused) {
                    this.play();
                } else {
                    this.pause();
                }
            },

            stop() {
                this.audio().pause();
                this.audio().currentTime = 0;
            },

            prev() {
                const index = this.index ? this.index - 1 : this.playlist.length - 1;
                this.play(index);
            },

            next() {
                const index = (this.index + 1) % this.playlist.length;
                this.play(index);
            }
        });
    </script>
</dom-module>
